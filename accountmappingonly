import os
import pandas as pd

# ==== Column names (edit these when source/lookup changes) ====
source_id_col = "AccountId"               # column in source CSV to map
lookup_key_col = "Legacy_SF_Record_ID__c"  # column in lookup with legacy IDs
lookup_value_col = "Id"                   # column in lookup with new IDs

# ==== File Paths ====
source_file = r"C:\Users\Sourav.Sindhikar\Downloads\Mapping\Output 2 - Usermapping\With Parent\UserMapping-Alliance_Parent_V1.csv"
lookup_file = r"C:\Users\Sourav.Sindhikar\Downloads\Mapping\Case_alliance_accountLKP.xlsx"
output_dir = r"C:\Users\Sourav.Sindhikar\Downloads\Mapping\Acount_mapping"
output_file = os.path.join(output_dir, "accountid_mapped.csv")
unmatched_file = os.path.join(output_dir, "no_match_accountid.csv")

# ==== Create output directory ====
os.makedirs(output_dir, exist_ok=True)

# ==== Remove old outputs ====
for path in (output_file, unmatched_file):
    if os.path.exists(path):
        os.remove(path)
        print(f"âš ï¸ Removed existing file: {path}")

# ==== Load lookup sheet ====
print("ğŸ“– Loading lookup file...")
if not os.path.exists(lookup_file):
    raise FileNotFoundError(f"Lookup file not found: {lookup_file}")

lookup_df = pd.read_excel(lookup_file, dtype=str).fillna("")
required_cols = {lookup_key_col, lookup_value_col}
missing = required_cols - set(lookup_df.columns)
if missing:
    raise ValueError(f"Missing column(s) in lookup file: {', '.join(missing)}")

for col in lookup_df.columns:
    lookup_df[col] = lookup_df[col].astype(str).str.strip()

dict_lookup = {
    str(k).strip().lower(): str(v).strip()
    for k, v in zip(lookup_df[lookup_key_col], lookup_df[lookup_value_col])
    if str(k).strip()
}

# ==== Mapping helper ====
def map_value(raw_value: str) -> str:
    raw_value = (raw_value or "").strip()
    if not raw_value:
        return ""
    return dict_lookup.get(raw_value.lower(), "")

# ==== Process source CSV ====
if not os.path.exists(source_file):
    raise FileNotFoundError(f"Source file not found: {source_file}")

chunk_size = 50_000
reader = pd.read_csv(source_file, dtype=str, chunksize=chunk_size)

header_written_mapped = False
header_written_unmatched = False
total_rows = matched_count = unmatched_count = 0

print("ğŸ”„ Processing source file in chunks...")
for i, chunk in enumerate(reader, start=1):
    chunk = chunk.fillna("")

    if source_id_col not in chunk.columns:
        print(f"âš ï¸ Column '{source_id_col}' missing in chunk {i}, skipping...")
        continue

    original_values = chunk[source_id_col].copy()
    chunk[source_id_col] = chunk[source_id_col].map(map_value)

    original_stripped = original_values.astype(str).str.strip()
    mapped_stripped = chunk[source_id_col].astype(str).str.strip()

    matched_mask = (original_stripped != "") & (mapped_stripped != "")
    unmatched_mask = (original_stripped != "") & (mapped_stripped == "")

    matched_chunk = chunk[matched_mask].copy()
    unmatched_chunk = chunk[unmatched_mask].copy()

    if len(unmatched_chunk) > 0:
        unmatched_chunk = unmatched_chunk.reset_index(drop=True)
        original_unmatched = original_values[unmatched_mask].reset_index(drop=True)
        unmatched_chunk[source_id_col] = original_unmatched

    if len(matched_chunk) > 0:
        matched_chunk.to_csv(
            output_file,
            index=False,
            mode="a" if header_written_mapped else "w",
            header=not header_written_mapped,
            encoding="utf-8-sig",
        )
        header_written_mapped = True
        matched_count += len(matched_chunk)

    if len(unmatched_chunk) > 0:
        unmatched_chunk.to_csv(
            unmatched_file,
            index=False,
            mode="a" if header_written_unmatched else "w",
            header=not header_written_unmatched,
            encoding="utf-8-sig",
        )
        header_written_unmatched = True
        unmatched_count += len(unmatched_chunk)

    total_rows += len(chunk)
    print(
        f"âœ… Chunk {i}: {len(chunk)} rows | Matched: {len(matched_chunk)} | Unmatched: {len(unmatched_chunk)}"
    )

print("\nâœ… Mapping completed!")
print(f"ğŸ“Š Total rows processed: {total_rows}")
print(f"âœ… Matched rows: {matched_count} â†’ {output_file}")
print(f"âš ï¸ Unmatched rows: {unmatched_count} â†’ {unmatched_file}")
