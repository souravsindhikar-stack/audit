import os
import sys
import pandas as pd

# ==== Configure Paths ====
SOURCE_FILE = r"C:\path\to\your\source.csv"
OUTPUT_DIR = r"C:\path\to\your\output\folder"
LOOKUP_FILE = r"C:\Users\Sourav.Sindhikar\Downloads\Mapping\Case_alliance_accountLKP.xlsx"

# ==== Constants ====
ARROW_ACCOUNT_ID = "001Wr00000mKja2IAC"
UNITY_ACCOUNT_ID = "001Wr00000mKWszIAG"
DEFAULT_BH_ID = "01mWr0000012RrmIAE"

def ensure_lookup(lookup_path):
    if not os.path.exists(lookup_path):
        print(f"‚ùå Lookup file not found: {lookup_path}")
        sys.exit(1)
    return lookup_path

def load_lookup(lookup_path):
    print("üìñ Loading lookup file...")
    df = pd.read_excel(lookup_path, dtype=str).fillna("")
    for col in df.columns:
        df[col] = df[col].astype(str).str.strip()

    if "Legacy_SF_Record_ID__c" not in df.columns or "Id" not in df.columns:
        print("‚ùå Lookup file missing Legacy_SF_Record_ID__c or Id columns.")
        sys.exit(1)

    acct_lookup = {
        legacy.lower(): new_id
        for legacy, new_id in zip(df["Legacy_SF_Record_ID__c"], df["Id"])
        if str(legacy).strip()
    }

    if "Expedite_Supplier__c" not in df.columns:
        print("‚ùå Lookup file missing Expedite_Supplier__c column.")
        sys.exit(1)

    expedite_lookup = {
        legacy.lower(): supplier
        for legacy, supplier in zip(df["Legacy_SF_Record_ID__c"], df["Expedite_Supplier__c"])
        if str(legacy).strip() and str(supplier).strip()
    }

    return acct_lookup, expedite_lookup

def apply_account_logic(row, acct_lookup):
    recordtype_name = row.get("Account.RecordType.Name", "")
    account_id = row.get("AccountId", "")
    key = str(account_id).strip().lower()

    if "arrow / verical" in recordtype_name.lower():
        return ARROW_ACCOUNT_ID
    if "unity" in recordtype_name.lower():
        return UNITY_ACCOUNT_ID
    if key and key in acct_lookup:
        return acct_lookup[key]
    return account_id

def main():
    print("=== Case Account & Business Hours Updater ===")

    if not os.path.exists(SOURCE_FILE):
        print(f"‚ùå Source file not found: {SOURCE_FILE}")
        sys.exit(1)

    os.makedirs(OUTPUT_DIR, exist_ok=True)
    matched_output = os.path.join(OUTPUT_DIR, "cases_updated.csv")
    expedite_unmatched_output = os.path.join(OUTPUT_DIR, "cases_expedite_unmatched.csv")

    lookup_path = ensure_lookup(LOOKUP_FILE)
    acct_lookup, expedite_lookup = load_lookup(lookup_path)

    print("üîÑ Reading source CSV...")
    df = pd.read_csv(SOURCE_FILE, dtype=str).fillna("")

    print("üß≠ Updating AccountId / BusinessHoursId...")
    df["AccountId"] = df.apply(lambda row: apply_account_logic(row, acct_lookup), axis=1)
    if "BusinessHoursId" in df.columns:
        df["BusinessHoursId"] = DEFAULT_BH_ID

    print("‚öôÔ∏è Mapping Expedite_Supplier__c...")
    if "Expedite_Supplier__c" not in df.columns:
        df["Expedite_Supplier__c"] = ""

    unmatched_rows = []

    def map_expedite(row):
        legacy = str(row.get("AccountId", "")).strip().lower()
        if legacy and legacy in expedite_lookup:
            return expedite_lookup[legacy]
        unmatched_rows.append(row.name)
        return row.get("Expedite_Supplier__c", "")

    df["Expedite_Supplier__c"] = df.apply(map_expedite, axis=1)

    unmatched_df = df.loc[unmatched_rows].copy() if unmatched_rows else pd.DataFrame(columns=df.columns)

    print(f"üíæ Saving main output: {matched_output}")
    df.to_csv(matched_output, index=False, encoding="utf-8-sig")

    if not unmatched_df.empty:
        print(f"üíæ Saving expedite-unmatched output: {expedite_unmatched_output}")
        unmatched_df.to_csv(expedite_unmatched_output, index=False, encoding="utf-8-sig")
    else:
        print("‚úÖ No unmatched expedite rows found.")

    print("üéâ Done!")

if __name__ == "__main__":
    main()
