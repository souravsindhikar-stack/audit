import os
import pandas as pd

# ========= USER INPUTS =========
SOURCE_FILE = r"C:\Users\Sourav.Sindhikar\Downloads\Mapping\Merge\merged_Alliance_case_tracker.csv"
USER_VLOOKUP_FILE = r"C:\Users\Sourav.Sindhikar\Downloads\Vlookup_mapping_file 5 2.csv"
OUTPUT_DIR = r"C:\Users\Sourav.Sindhikar\Downloads\Mapping\Case_Status_Tracker\Mapped"
MAPPED_OUTPUT_FILE = os.path.join(OUTPUT_DIR, "UserMapping_Only.csv")
# ========= CONSTANTS =========
DEFAULT_OWNER_ID = "005Wr00000ECxAjIAL"
DEFAULT_CREATEDBY_LASTMODIFIED_ID = "005A0000000rXeVIAU"
RECORD_TYPE_ID = "012Wr000001ezc5IAA"
CHUNK_SIZE = 50_000
# ========= END OF USER INPUTS =========


def map_user_id_factory(vlookup_df):
    for col in vlookup_df.columns:
        vlookup_df[col] = vlookup_df[col].astype(str).str.strip()

    dict_b_to_c = {
        str(k).lower(): str(v)
        for k, v in zip(vlookup_df["digital_prod_Id"], vlookup_df["digital_Global_ID__c"])
    }
    dict_g_to_f = {
        str(k).lower(): str(v)
        for k, v in zip(vlookup_df["merge_Global_ID__c"], vlookup_df["merge_Id"])
    }
    dict_email_name_to_f = {
        (str(row["merge_email"]).lower(), str(row["merge_Name"]).lower()): str(row["merge_Id"])
        for _, row in vlookup_df.iterrows()
    }
    dict_b_to_email_name = {
        str(row["digital_prod_Id"]).lower(): (
            str(row["digital_Email"]).lower(),
            str(row["digital_Name"]).lower(),
        )
        for _, row in vlookup_df.iterrows()
    }

    def map_id(digital_prod_id):
        if not digital_prod_id:
            return ""
        digital_prod_id_lc = str(digital_prod_id).strip().lower()

        digital_global_id = dict_b_to_c.get(digital_prod_id_lc, "").lower()
        if digital_global_id and digital_global_id in dict_g_to_f:
            return dict_g_to_f[digital_global_id]

        email_name = dict_b_to_email_name.get(digital_prod_id_lc)
        if email_name:
            email_name_lc = (email_name[0].lower(), email_name[1].lower())
            return dict_email_name_to_f.get(email_name_lc, "")

        return ""

    return map_id


def main():
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    if os.path.exists(MAPPED_OUTPUT_FILE):
        os.remove(MAPPED_OUTPUT_FILE)
        print(f"‚ö†Ô∏è Removed existing output file: {MAPPED_OUTPUT_FILE}")

    if not os.path.exists(SOURCE_FILE):
        raise FileNotFoundError(f"Source file not found: {SOURCE_FILE}")

    user_vlookup_df = pd.read_csv(USER_VLOOKUP_FILE, dtype=str).fillna("")
    map_user_id = map_user_id_factory(user_vlookup_df)

    reader = pd.read_csv(SOURCE_FILE, dtype=str, chunksize=CHUNK_SIZE)
    header_written_main = False
    total_rows = 0

    for chunk_idx, chunk in enumerate(reader, start=1):
        chunk = chunk.fillna("")

        if "OwnerId" in chunk.columns:
            chunk["OwnerId"] = chunk["OwnerId"].map(map_user_id)
            mask = chunk["OwnerId"].astype(str).str.strip() == ""
            chunk.loc[mask, "OwnerId"] = DEFAULT_OWNER_ID

        if "CreatedById" in chunk.columns:
            chunk["CreatedById"] = chunk["CreatedById"].map(map_user_id)
            mask = chunk["CreatedById"].astype(str).str.strip() == ""
            chunk.loc[mask, "CreatedById"] = DEFAULT_CREATEDBY_LASTMODIFIED_ID

        if "LastModifiedById" in chunk.columns:
            chunk["LastModifiedById"] = chunk["LastModifiedById"].map(map_user_id)
            mask = chunk["LastModifiedById"].astype(str).str.strip() == ""
            chunk.loc[mask, "LastModifiedById"] = DEFAULT_CREATEDBY_LASTMODIFIED_ID

        # Replace RecordTypeId if it exists, otherwise add it
        chunk["RecordTypeId"] = RECORD_TYPE_ID

        chunk.to_csv(
            MAPPED_OUTPUT_FILE,
            index=False,
            mode="a" if header_written_main else "w",
            header=not header_written_main,
            encoding="utf-8-sig",
        )
        header_written_main = True
        total_rows += len(chunk)
        print(f"‚úÖ Chunk {chunk_idx}: {len(chunk)} rows processed")

    print("\n‚úÖ Completed")
    print(f"üìä Total rows processed: {total_rows}")
    print(f"üìù Output file: {MAPPED_OUTPUT_FILE}")


if __name__ == "__main__":
    main()
